name: Mobile Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy_android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Set up JDK 8.x
        uses: actions/setup-java@v1
        with:
          java-version: '8.x'
      
      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
      
      - name: Install flutter dependency packages
        run: flutter pub get
      
  deploy_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'stable'

      - name: Install flutter dependency packages
        run: flutter pub get

      - name: Encode export options plist file
        run: |
          echo "${{ secrets.EXPORT_OPTIONS_PLIST }}" > ExportOptions.plist.txt
          base64 --decode ExportOptions.plist.txt > ExportOptions.plist

      - name: Run fastlane lane
        run: fastlane ios custome_lane # misstake of lane name
  
  teardown:
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    needs: [ deploy_android, deploy_ios ]

    steps:
      - name: Notify results to Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: all
          custom_payload: | 
            {
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                pretext: '${{ job.status }}' === 'success' ? 'CI が成功したみたい :tada:' : 'CI が失敗したみたい... :sweat_drops:',
                author_name: '${{ github.actor }}',
                author_icon: '${{ github.event.sender.avatar_url }}',
                text: '${{ github.event.head_commit.message }}',
                fields: [
                  {
                    title: 'repo',
                    value: `${process.env.AS_REPO}`,
                    short: false
                  },
                  {
                    title: 'commit',
                    value: `${process.env.AS_COMMIT}`,
                    short: true
                  },
                  {
                    title: 'job',
                    value: `${process.env.AS_JOB}`,
                    short: true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()